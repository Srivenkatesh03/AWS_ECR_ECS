// Jenkinsfile
pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'ap-south-1'                    // change if needed
    ECR_REPO          = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_DEFAULT_REGION}.amazonaws.com/${PROJECT_NAME}"
    PROJECT_NAME      = "svc-demo"
  }

  parameters {
    string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional: image tag (if empty uses GIT_COMMIT)')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.IMAGE_TAG = params.IMAGE_TAG ?: sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('app') {
          sh "docker build -t ${PROJECT_NAME}:${IMAGE_TAG} ."
        }
      }
    }

    stage('Authenticate to ECR') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']]) {
          sh '''
            aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com
          '''
        }
      }
    }

    stage('Push to ECR') {
      steps {
        script {
          sh """
            # ensure repo exists
            aws ecr describe-repositories --repository-names ${PROJECT_NAME}-repo || aws ecr create-repository --repository-name ${PROJECT_NAME}-repo
            docker tag ${PROJECT_NAME}:${IMAGE_TAG} ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${PROJECT_NAME}-repo:${IMAGE_TAG}
            docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${PROJECT_NAME}-repo:${IMAGE_TAG}
          """
        }
      }
    }

    stage('Terraform Init & Plan') {
      steps {
        dir('terraform') {
          withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']]) {
            sh '''
              terraform init -input=false
              terraform plan -var="region=${AWS_DEFAULT_REGION}" -var="project=${PROJECT_NAME}" -var="desired_count=2" -out=tfplan
            '''
          }
        }
      }
    }

    stage('Terraform Apply (deploy)') {
      steps {
        dir('terraform') {
          withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']]) {
            sh '''
              # pass image tag by overriding container definition or ensure Terraform uses :latest
              terraform apply -auto-approve tfplan || terraform apply -auto-approve
            '''
          }
        }
      }
    }

    stage('Post-deploy Smoke Test') {
      steps {
        dir('terraform') {
          script {
            def alb = sh(script: "terraform output -raw alb_dns_name", returnStdout: true).trim()
            echo "ALB DNS: ${alb}"
            sh "curl -f http://${alb}/ || true"
          }
        }
      }
    }
  }

  post {
    failure {
      mail to: 'you@example.com',
           subject: "Build failed: ${env.JOB_NAME} ${env.BUILD_NUMBER}",
           body: "Build failed. See console output at ${env.BUILD_URL}"
    }
  }
}
